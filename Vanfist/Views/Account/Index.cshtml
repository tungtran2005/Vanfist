@model Vanfist.DTOs.Requests.UpdateAccountRequest

@{
	ViewData["Title"] = "Thông tin cá nhân";
	var account = ViewBag.Account;
	var defaultAddress = ViewBag.DefaultAddress;

	var initial = string.IsNullOrWhiteSpace((string?)account?.FirstName)
		? "U"
		: ((string)account.FirstName).Substring(0, 1).ToUpperInvariant();
}

<link rel="stylesheet" href="~/css/account.css" asp-append-version="true"/>

<div class="container my-4">
	<div class="row g-4">
		<div class="col-12 col-lg-3">
			<div class="card shadow-sm mb-3">
				<div class="card-body d-flex align-items-center">
					<div class="avatar-circle me-3">@initial</div>
					<div>
						<div class="text-muted">Xin chào,</div>
						<div class="fw-semibold">@account.FirstName @account.LastName</div>
					</div>
				</div>
			</div>

			<div class="card shadow-sm">
				<div class="card-header bg-white fw-semibold">Thông tin xe</div>
				<ul class="list-group list-group-flush small">
					<li class="list-group-item d-flex align-items-center">
						<a href="#" class="text-decoration-none section-link" data-section="vehicles">Xe của tôi</a>
					</li>
				</ul>
			</div>

			<div class="card shadow-sm mt-3">
				<div class="card-header bg-white fw-semibold">Đặt hàng và dịch vụ</div>
				<ul class="list-group list-group-flush small">
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="transactions">Lịch sử giao dịch</a></li>
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="maintenance">Bảo dưỡng - Sửa chữa</a></li>
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="battery">Thuê pin</a></li>
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="charging">Lịch sử sạc pin</a></li>
				</ul>
			</div>

			<div class="card shadow-sm mt-3">
				<div class="card-header bg-white fw-semibold">Tài khoản</div>
				<ul class="list-group list-group-flush small">
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="personal">Thông tin cá nhân</a></li>
					<li class="list-group-item"><a href="#" class="text-decoration-none section-link"
					                               data-section="support">Yêu cầu hỗ trợ</a></li>
					<li class="list-group-item">
						<form asp-controller="Auth" asp-action="Logout" method="post" class="m-0 p-0">
							<button type="submit" class="btn btn-link p-0 text-decoration-none">Đăng xuất</button>
						</form>
					</li>
				</ul>
			</div>
		</div>

		<div class="col-12 col-lg-9">
			<!-- Personal Info -->
			<div id="section-personal" class="card shadow-sm content-section">
				<div class="card-header bg-white d-flex justify-content-between align-items-center">
					<div class="fw-semibold">Thông tin cá nhân</div>
					<a href="#" class="small section-link" data-section="update">Chỉnh sửa thông tin</a>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<div class="col-12 col-md-6">
							<div class="text-muted small">Họ và tên</div>
							<div class="fw-semibold">@account.FirstName @account.LastName</div>
						</div>
						<div class="col-12 col-md-6">
							<div class="text-muted small">Email</div>
							<div class="fw-semibold">@account.Email</div>
						</div>
						<div class="col-12 col-md-6">
							<div class="text-muted small">Số điện thoại</div>
							<div class="fw-semibold">@account.Number</div>
						</div>
						<div class="col-12 col-md-6">
							<div class="text-muted small">Địa chỉ</div>
							<div class="fw-semibold">
								@(
								(defaultAddress == null
								 || (string.IsNullOrWhiteSpace(defaultAddress.Detail) && string.IsNullOrWhiteSpace(defaultAddress.City)))
									? "Chưa có"
									: $"{defaultAddress.Detail}, {defaultAddress.City}"
								)
							</div>
						</div>
					</div>

					<hr class="my-4"/>

					<div class="d-flex justify-content-between align-items-center">
						<div class="text-muted small">Mật khẩu</div>
						<a href="#" class="small section-link" data-section="change-password">Đổi mật khẩu</a>
					</div>
				</div>
			</div>

			<!-- Update Information -->
			<div id="section-update" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Cập nhật thông tin</div>
				<div class="card-body">
					<form asp-controller="Account" asp-action="UpdateInformation" method="post" class="row g-3">
						<div class="col-12 col-md-6">
							<label asp-for="LastName" class="form-label small text-muted">Họ</label>
							<input asp-for="LastName" class="form-control" value="@account.LastName"/>
							<span asp-validation-for="LastName" class="text-danger"></span>
						</div>

						<div class="col-12 col-md-6">
							<label asp-for="FirstName" class="form-label small text-muted">Tên</label>
							<input asp-for="FirstName" class="form-control" value="@account.FirstName"/>
							<span asp-validation-for="FirstName" class="text-danger"></span>
						</div>

						<div class="col-12 col-md-6">
							<label class="form-label small text-muted" for="Email">Email</label>
							<input type="email" class="form-control" id="Email" name="Email" value="@account.Email"
							       disabled="disabled"/>
						</div>

						<div class="col-12 col-md-6">
							<label asp-for="Number" class="form-label small text-muted">Số điện thoại</label>
							<input asp-for="Number" class="form-control" value="@account.Number"/>
							<span asp-validation-for="Number" class="text-danger"></span>
						</div>

						<div class="col-12 col-md-8">
							<label asp-for="Detail" class="form-label small text-muted">Địa chỉ (chi tiết)</label>
							<input asp-for="Detail" class="form-control" value="@defaultAddress?.Detail"/>
							<span asp-validation-for="Detail" class="text-danger"></span>
						</div>

						<div class="col-12 col-md-4">
							<label asp-for="City" class="form-label small text-muted">Tỉnh/Thành phố</label>
							<input asp-for="City" class="form-control" value="@defaultAddress?.City"/>
							<span asp-validation-for="City" class="text-danger"></span>
						</div>

						<div class="col-12 d-flex gap-2 mt-2">
							<button type="button" class="btn btn-outline-secondary section-link"
							        data-section="personal">Trở về
							</button>
							<button type="submit" class="btn btn-primary">Cập nhật thông tin</button>
						</div>
					</form>
				</div>
			</div>

			<!-- Change Password -->
			<div id="section-change-password" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Đổi mật khẩu</div>
				<div class="card-body">
					<form asp-controller="Account" asp-action="ChangePassword" method="post" class="row g-3"
					      id="changePasswordForm">
						<div class="col-12 col-md-6">
							<label class="form-label small text-muted" for="OldPassword">Mật khẩu hiện tại</label>
							<input type="password" class="form-control" id="OldPassword" name="OldPassword"
							       required/>
						</div>
						<div class="col-12 col-md-6">
							<label class="form-label small text-muted" for="NewPassword">Mật khẩu mới</label>
							<input type="password" class="form-control" id="NewPassword" name="NewPassword"
							       required/>
						</div>
						<div class="col-12 col-md-6">
							<label class="form-label small text-muted" for="ConfirmPassword">Xác nhận mật khẩu
								mới</label>
							<input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword"
							       required/>
							<div id="ConfirmPasswordHelp" class="form-text text-danger d-none">Mật khẩu xác nhận
								không khớp.
							</div>
						</div>

						<div class="col-12 d-flex gap-2 mt-2">
							<button type="button" class="btn btn-outline-secondary section-link"
							        data-section="personal">Trở về
							</button>
							<button type="submit" class="btn btn-primary" id="btnChangePasswordSubmit">Xác nhận
							</button>
						</div>
					</form>
				</div>
			</div>

			<!-- Vehicles -->
			<div id="section-vehicles" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Xe của tôi</div>
				<div class="card-body">
					<div class="text-muted">Quý khách chưa sở hữu xe nào.</div>
				</div>
			</div>

			<!-- Transactions -->
			<div id="section-transactions" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Đơn hàng của bạn</div>
				<div class="card-body" id="transactionsContainer">
				</div>
			</div>


			<!-- Maintenance -->
			<div id="section-maintenance" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Bảo dưỡng - Sửa chữa</div>
				<div class="card-body">
					<div class="text-muted">Quý khách có thể đặt lịch bảo dưỡng thông qua dịch vụ yêu cầu hỗ trợ.
					</div>
				</div>
			</div>

			<!-- Battery Rental -->
			<div id="section-battery" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Thuê pin</div>
				<div class="card-body">
					<div class="text-muted">Quý khách chưa thuê pin.</div>
				</div>
			</div>

			<!-- Charging History -->
			<div id="section-charging" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Lịch sử sạc pin</div>
				<div class="card-body">
					<div class="text-muted">Quý khách chưa sạc pin.</div>
				</div>
			</div>

			<!-- Support -->
			<div id="section-support" class="card shadow-sm content-section" style="display:none;">
				<div class="card-header bg-white fw-semibold">Yêu cầu hỗ trợ</div>
				<div class="card-body">
					<div class="text-muted">Số điện thoại hỗ trợ: 123x456x78.</div>
					<div class="text-muted">Email: gmail@vanfist.com.</div>
				</div>
			</div>
		</div>
	</div>
</div>


@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const links = document.querySelectorAll('.section-link');
			const sections = document.querySelectorAll('.content-section');

			function showSection(name) {
				sections.forEach(s => s.style.display = 'none');
				const el = document.getElementById(`section-${name}`);
				if (el) el.style.display = '';
			}

			links.forEach(link => {
				link.addEventListener('click', function (e) {
					e.preventDefault();
					const section = this.getAttribute('data-section');
					showSection(section);
				});
			});

			// Default section
			showSection('personal');

			const form = document.getElementById('changePasswordForm');
			if (form) {
				const newPwd = form.querySelector('#NewPassword');
				const confirmPwd = form.querySelector('#ConfirmPassword');
				const submitBtn = form.querySelector('#btnChangePasswordSubmit');
				const help = document.getElementById('ConfirmPasswordHelp');

				function validatePasswordsMatch() {
					const match = confirmPwd.value.length > 0 && newPwd.value === confirmPwd.value;
					if (!match) {
						help.classList.remove('d-none');
						confirmPwd.setCustomValidity('Mật khẩu xác nhận không khớp.');
						submitBtn.disabled = true;
					} else {
						help.classList.add('d-none');
						confirmPwd.setCustomValidity('');
						submitBtn.disabled = false;
					}
				}

				newPwd.addEventListener('input', validatePasswordsMatch);
				confirmPwd.addEventListener('input', validatePasswordsMatch);

				form.addEventListener('submit', function (e) {
					validatePasswordsMatch();
					if (!form.checkValidity()) {
						e.preventDefault();
						e.stopPropagation();
						form.reportValidity();
					}
				});

				validatePasswordsMatch();
			}
		});
	</script>
	<script>
		$(document).ready(function () {
			$("#transactionsContainer").load("/Invoice/GetPagedInvoicePartial");
		});
		function loadInvoicePage(page) {
			$("#transactionsContainer").load(`/Invoice/GetPagedInvoicePartial?page=${page}`);
		}

		function deleteInvoice(id) {
			if (!confirm("Bạn có chắc muốn xóa hóa đơn #" + id + " không?")) return;

			$.ajax({
				url: '/Invoice/DeleteInvoice',
				type: 'POST',
				data: { id: id },
				success: function (res) {
					if (res.success) {
						alert(res.message);
						$("#transactionsContainer").load('/Invoice/GetPagedInvoicePartial');
					} else {
						alert(res.message);
					}
				},
				error: function () {
					alert("Lỗi trong quá trình xóa hóa đơn!");
				}
			});
		}
		function updateInvoiceStatus(invoiceId, Status, Type) {
			$.ajax({
				url: '/Invoice/UpdateInvoice',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					invoiceId: invoiceId,
					status: Status,
					type: Type
				}),
				success: function (res) {
					if (res.success) {
						alert(res.message);
						loadInvoicePage(1);
					} else {
						alert(res.message);
					}
				},
				error: function () {
					alert('Có lỗi xảy ra khi cập nhật!');
				}
			});
		}
	</script>
}
